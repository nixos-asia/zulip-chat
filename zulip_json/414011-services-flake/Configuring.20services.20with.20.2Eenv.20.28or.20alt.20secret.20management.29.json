[
    {
        "content": "<h1><strong>Background</strong> (Feel free to skip)</h1>\n<p>I am quite new to nix, nixos, flakes, devshells, etc. I am, however, determined to find a reproducible and declarative way to handle dependencies and development environments, including for services. I looked into devenv, but it seems services-flake is better tailored to people already using nixos and flakes.</p>\n<p>I'm sorry if the below is filled with stupid questions and there is some site I should have just gone to where all the answers lie. That being said, I've tried very hard to figure this out and cannot find any resources to help me. ChatGPT is just useless for this too, as it will spit out one terrible duct-tape solution after another. I may very well be a case of \"once you know the search term, the answer is obvious\".</p>\n<p>For context I'm a software engineering student with a few years of experience. I've been running NixOS as my daily driver for about a month.</p>\n<h1>The problem</h1>\n<p>Here's the situation:<br>\nI've been using nix devshells in flakes to manage project dependencies. I need to add a postgres instance to one of these. I followed the guides online and got this working nicely. The issue is configuration of the service as it starts up for the first time. Since I'm more used to docker for this purpose, I expect to be able to set an initial database, user, an port through environment variables. However, this does not seem to be the way to go at all for flakes.</p>\n<h2>Questions</h2>\n<p>I'm therefore left wondering:</p>\n<ul>\n<li>Is there a way to include an .env file for configuring the postgres service with services-flake?</li>\n<li>Am I really supposed to use some other kind of secret management?</li>\n<li>Am I not actually supposed to expect configuration of the database to happen at initialization, instead using a script or some tool to set this up afterwards?</li>\n</ul>\n<p>This is the flake I'm currently using on the project:</p>\n<div class=\"codehilite\" data-code-language=\"Nix\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"ss\">description</span> <span class=\"o\">=</span> <span class=\"s2\">\"My project with postgres service\"</span><span class=\"p\">;</span>\n\n  <span class=\"ss\">inputs</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    nixpkgs<span class=\"o\">.</span><span class=\"ss\">url</span> <span class=\"o\">=</span> <span class=\"s2\">\"github:nixos/nixpkgs/nixos-25.05\"</span><span class=\"p\">;</span>\n    flake-parts<span class=\"o\">.</span><span class=\"ss\">url</span> <span class=\"o\">=</span> <span class=\"s2\">\"github:hercules-ci/flake-parts\"</span><span class=\"p\">;</span>\n    process-compose-flake<span class=\"o\">.</span><span class=\"ss\">url</span> <span class=\"o\">=</span> <span class=\"s2\">\"github:Platonic-Systems/process-compose-flake\"</span><span class=\"p\">;</span>\n    services-flake<span class=\"o\">.</span><span class=\"ss\">url</span> <span class=\"o\">=</span> <span class=\"s2\">\"github:juspay/services-flake\"</span><span class=\"p\">;</span>\n    systems<span class=\"o\">.</span><span class=\"ss\">url</span> <span class=\"o\">=</span> <span class=\"s2\">\"github:nix-systems/default\"</span><span class=\"p\">;</span>\n  <span class=\"p\">};</span>\n\n  <span class=\"ss\">outputs</span> <span class=\"o\">=</span> inputs<span class=\"p\">:</span>\n    inputs<span class=\"o\">.</span>flake-parts<span class=\"o\">.</span>lib<span class=\"o\">.</span>mkFlake <span class=\"p\">{</span> <span class=\"k\">inherit</span> inputs<span class=\"p\">;</span> <span class=\"p\">}</span> <span class=\"p\">{</span>\n      <span class=\"ss\">systems</span> <span class=\"o\">=</span> <span class=\"nb\">import</span> inputs<span class=\"o\">.</span>systems<span class=\"p\">;</span>\n      <span class=\"ss\">imports</span> <span class=\"o\">=</span> <span class=\"p\">[</span> inputs<span class=\"o\">.</span>process-compose-flake<span class=\"o\">.</span>flakeModule <span class=\"p\">];</span>\n\n      <span class=\"ss\">perSystem</span> <span class=\"o\">=</span> <span class=\"p\">{</span> config<span class=\"p\">,</span> pkgs<span class=\"p\">,</span> <span class=\"o\">...</span> <span class=\"p\">}:</span> <span class=\"p\">{</span>\n        <span class=\"c1\"># Define a process-compose environment</span>\n        process-compose<span class=\"o\">.</span><span class=\"ss\">default</span> <span class=\"o\">=</span> <span class=\"p\">{</span> config<span class=\"p\">,</span> <span class=\"o\">...</span> <span class=\"p\">}:</span> <span class=\"p\">{</span>\n          <span class=\"ss\">imports</span> <span class=\"o\">=</span> <span class=\"p\">[</span> inputs<span class=\"o\">.</span>services-flake<span class=\"o\">.</span>processComposeModules<span class=\"o\">.</span>default <span class=\"p\">];</span>\n\n          services<span class=\"o\">.</span>postgres<span class=\"o\">.</span><span class=\"s2\">\"pg1\"</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"ss\">enable</span> <span class=\"o\">=</span> <span class=\"no\">true</span><span class=\"p\">;</span>\n            <span class=\"ss\">initialDatabases</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n              <span class=\"p\">{</span> <span class=\"ss\">name</span> <span class=\"o\">=</span> <span class=\"s2\">\"db\"</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n            <span class=\"p\">];</span>\n          <span class=\"p\">};</span>\n        <span class=\"p\">};</span>\n\n        devShells<span class=\"o\">.</span><span class=\"ss\">default</span> <span class=\"o\">=</span> pkgs<span class=\"o\">.</span>mkShell <span class=\"p\">{</span>\n          <span class=\"ss\">inputsFrom</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            config<span class=\"o\">.</span>process-compose<span class=\"o\">.</span>default<span class=\"o\">.</span>services<span class=\"o\">.</span>outputs<span class=\"o\">.</span>devShell\n          <span class=\"p\">];</span>\n          <span class=\"ss\">packages</span> <span class=\"o\">=</span> <span class=\"k\">with</span> pkgs<span class=\"p\">;</span> <span class=\"p\">[</span>\n            nodejs\n          <span class=\"p\">];</span>\n        <span class=\"p\">};</span>\n      <span class=\"p\">};</span>\n    <span class=\"p\">};</span>\n  <span class=\"p\">}</span>\n</code></pre></div>\n<p>I find it very satisfying to learn the proper way of things, using trustworthy resources. I'd be happy to get any tips on where I should go to learn more about this! It's just been wildly confusing to try and google/chatgpt my way through this problem.</p>",
        "id": 542068516,
        "sender_full_name": "Cepheus",
        "timestamp": 1759158837
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"970543\">@Cepheus</span> </p>\n<p>We recommend keeping all the configuration of a service in <code>services.&lt;name&gt;.&lt;instance-name&gt;</code> to avoid magic. Expecting a local copy (not committed) of the .env to have specific env vars is that magic.</p>\n<p>If your main concern is secrets management and this configuration is only used for development and testing:</p>\n<ul>\n<li>commit the secret (used for development and testing only) in the configuration </li>\n<li>If you are worried about committing the test-only secret as plain text you can commit an encrypted secret with <a href=\"https://github.com/aciceri/agenix-shell\">https://github.com/aciceri/agenix-shell</a> and the likes.</li>\n</ul>",
        "id": 542214436,
        "sender_full_name": "Shivaraj B H",
        "timestamp": 1759221309
    }
]