[
    {
        "content": "<p>Shrink the initrd, how?</p>\n<p>The documentation states a minimum 1.5GB RAM requirement, but my target host has only 900MB (yeah!, needs to be a cheap proxy).</p>\n<p>Does anyone know how I can shrink the initrd (<code>makeInitrdNG</code>?)? &mdash; and even more importantly test that reliably?</p>\n<ul>\n<li>kexec image: <a href=\"https://github.com/nix-community/nixos-images?tab=readme-ov-file#kexec-tarballs\">https://github.com/nix-community/nixos-images?tab=readme-ov-file#kexec-tarballs</a></li>\n<li><a href=\"https://github.com/nix-community/nixos-images/blob/9dd480c8be0ec772bb73380c641f975c0f946b4a/nix/kexec-installer/test.nix#L27\">some tests</a> which don't finish on my machine <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span> </li>\n<li><a href=\"https://github.com/nix-community/nixos-images/blob/9dd480c8be0ec772bb73380c641f975c0f946b4a/nix/kexec-installer/module.nix#L40\">https://github.com/nix-community/nixos-images/blob/9dd480c8be0ec772bb73380c641f975c0f946b4a/nix/kexec-installer/module.nix#L40</a></li>\n</ul>\n<p>What is all that is there in an initrd and how can I minimalize that which there is? &mdash; I've never touched this topic and am finding myself on the bottom of a climb that I wouldn't want to do on my own, alone.</p>",
        "id": 417271466,
        "sender_full_name": "David Arnold",
        "timestamp": 1705941831
    },
    {
        "content": "<p>kexec image uses <a href=\"https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/installer/netboot/netboot-base.nix\">netboot-base.nix</a> module which depends on <a href=\"https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/profiles/base.nix\">profiles/base.nix</a>, and this base module has a lot of packages by default, you can probably override it to remove unwanted base packages, which will reduce the kexec image size.</p>",
        "id": 417286014,
        "sender_full_name": "Shivaraj B H",
        "timestamp": 1705946446
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 417286696,
        "sender_full_name": "Shivaraj B H",
        "timestamp": 1705946699
    },
    {
        "content": "<p>I think it's here in the squashfsStore where it get's heavy:</p>\n<div class=\"codehilite\" data-code-language=\"Nix\"><pre><span></span><code>    <span class=\"c1\"># Create the initrd</span>\n    system<span class=\"o\">.</span>build<span class=\"o\">.</span><span class=\"ss\">netbootRamdisk</span> <span class=\"o\">=</span> pkgs<span class=\"o\">.</span>makeInitrdNG <span class=\"p\">{</span>\n      <span class=\"k\">inherit</span> <span class=\"p\">(</span>config<span class=\"o\">.</span>boot<span class=\"o\">.</span>initrd<span class=\"p\">)</span> compressor<span class=\"p\">;</span>\n      <span class=\"ss\">prepend</span> <span class=\"o\">=</span> <span class=\"p\">[</span> <span class=\"s2\">\"</span><span class=\"si\">${</span>config<span class=\"o\">.</span>system<span class=\"o\">.</span>build<span class=\"o\">.</span>initialRamdisk<span class=\"si\">}</span><span class=\"s2\">/initrd\"</span> <span class=\"p\">];</span>\n\n      <span class=\"ss\">contents</span> <span class=\"o\">=</span>\n        <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"ss\">object</span> <span class=\"o\">=</span> config<span class=\"o\">.</span>system<span class=\"o\">.</span>build<span class=\"o\">.</span>squashfsStore<span class=\"p\">;</span>\n            <span class=\"ss\">symlink</span> <span class=\"o\">=</span> <span class=\"s2\">\"/nix-store.squashfs\"</span><span class=\"p\">;</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">];</span>\n    <span class=\"p\">};</span>\n</code></pre></div>\n<p>and then here:</p>\n<div class=\"codehilite\" data-code-language=\"Nix\"><pre><span></span><code>  <span class=\"ss\">initialRamdisk</span> <span class=\"o\">=</span> pkgs<span class=\"o\">.</span>makeInitrdNG <span class=\"p\">{</span>\n    <span class=\"ss\">name</span> <span class=\"o\">=</span> <span class=\"s2\">\"initrd-</span><span class=\"si\">${</span>kernel-name<span class=\"si\">}</span><span class=\"s2\">\"</span><span class=\"p\">;</span>\n    <span class=\"k\">inherit</span> <span class=\"p\">(</span>config<span class=\"o\">.</span>boot<span class=\"o\">.</span>initrd<span class=\"p\">)</span> compressor compressorArgs prepend<span class=\"p\">;</span>\n    <span class=\"k\">inherit</span> <span class=\"p\">(</span>cfg<span class=\"p\">)</span> strip<span class=\"p\">;</span>\n\n    <span class=\"ss\">contents</span> <span class=\"o\">=</span> <span class=\"nb\">map</span> <span class=\"p\">(</span>path<span class=\"p\">:</span> <span class=\"p\">{</span> <span class=\"ss\">object</span> <span class=\"o\">=</span> path<span class=\"p\">;</span> <span class=\"ss\">symlink</span> <span class=\"o\">=</span> <span class=\"s2\">\"\"</span><span class=\"p\">;</span> <span class=\"p\">})</span> <span class=\"p\">(</span>subtractLists cfg<span class=\"o\">.</span>suppressedStorePaths cfg<span class=\"o\">.</span>storePaths<span class=\"p\">)</span>\n      <span class=\"o\">++</span> mapAttrsToList <span class=\"p\">(</span>_<span class=\"p\">:</span> v<span class=\"p\">:</span> <span class=\"p\">{</span> <span class=\"ss\">object</span> <span class=\"o\">=</span> v<span class=\"o\">.</span>source<span class=\"p\">;</span> <span class=\"ss\">symlink</span> <span class=\"o\">=</span> v<span class=\"o\">.</span>target<span class=\"p\">;</span> <span class=\"p\">})</span> <span class=\"p\">(</span>filterAttrs <span class=\"p\">(</span>_<span class=\"p\">:</span> v<span class=\"p\">:</span> v<span class=\"o\">.</span>enable<span class=\"p\">)</span> cfg<span class=\"o\">.</span>contents<span class=\"p\">);</span>\n  <span class=\"p\">};</span>\n</code></pre></div>\n<p>with</p>\n<div class=\"codehilite\" data-code-language=\"Nix\"><pre><span></span><code>      <span class=\"ss\">contents</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s2\">\"/tmp/.keep\"</span><span class=\"o\">.</span><span class=\"ss\">text</span> <span class=\"o\">=</span> <span class=\"s2\">\"systemd requires the /tmp mount point in the initrd cpio archive\"</span><span class=\"p\">;</span>\n        <span class=\"s2\">\"/init\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> <span class=\"s2\">\"</span><span class=\"si\">${</span>cfg<span class=\"o\">.</span>package<span class=\"si\">}</span><span class=\"s2\">/lib/systemd/systemd\"</span><span class=\"p\">;</span>\n        <span class=\"s2\">\"/etc/systemd/system\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> stage1Units<span class=\"p\">;</span>\n\n        <span class=\"s2\">\"/etc/systemd/system.conf\"</span><span class=\"o\">.</span><span class=\"ss\">text</span> <span class=\"o\">=</span> <span class=\"s s-Multiline\">''</span>\n<span class=\"s s-Multiline\">          [Manager]</span>\n<span class=\"s s-Multiline\">          DefaultEnvironment=PATH=/bin:/sbin</span>\n<span class=\"s s-Multiline\">          </span><span class=\"si\">${</span>cfg<span class=\"o\">.</span>extraConfig<span class=\"si\">}</span>\n<span class=\"s s-Multiline\">          ManagerEnvironment=</span><span class=\"si\">${</span>lib<span class=\"o\">.</span>concatStringsSep <span class=\"s2\">\" \"</span> <span class=\"p\">(</span>lib<span class=\"o\">.</span>mapAttrsToList <span class=\"p\">(</span>n<span class=\"p\">:</span> v<span class=\"p\">:</span> <span class=\"s2\">\"</span><span class=\"si\">${</span>n<span class=\"si\">}</span><span class=\"s2\">=</span><span class=\"si\">${</span>lib<span class=\"o\">.</span>escapeShellArg v<span class=\"si\">}</span><span class=\"s2\">\"</span><span class=\"p\">)</span> cfg<span class=\"o\">.</span>managerEnvironment<span class=\"p\">)</span><span class=\"si\">}</span>\n<span class=\"s s-Multiline\">        ''</span><span class=\"p\">;</span>\n\n        <span class=\"s2\">\"/lib\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> <span class=\"s2\">\"</span><span class=\"si\">${</span>modulesClosure<span class=\"si\">}</span><span class=\"s2\">/lib\"</span><span class=\"p\">;</span>\n\n        <span class=\"s2\">\"/etc/modules-load.d/nixos.conf\"</span><span class=\"o\">.</span><span class=\"ss\">text</span> <span class=\"o\">=</span> concatStringsSep <span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span> config<span class=\"o\">.</span>boot<span class=\"o\">.</span>initrd<span class=\"o\">.</span>kernelModules<span class=\"p\">;</span>\n\n        <span class=\"c1\"># We can use either ! or * to lock the root account in the</span>\n        <span class=\"c1\"># console, but some software like OpenSSH won't even allow you</span>\n        <span class=\"c1\"># to log in with an SSH key if you use ! so we use * instead</span>\n        <span class=\"s2\">\"/etc/shadow\"</span><span class=\"o\">.</span><span class=\"ss\">text</span> <span class=\"o\">=</span> <span class=\"s2\">\"root:</span><span class=\"si\">${</span><span class=\"k\">if</span> isBool cfg<span class=\"o\">.</span>emergencyAccess <span class=\"k\">then</span> optionalString <span class=\"p\">(</span><span class=\"o\">!</span>cfg<span class=\"o\">.</span>emergencyAccess<span class=\"p\">)</span> <span class=\"s2\">\"*\"</span> <span class=\"k\">else</span> cfg<span class=\"o\">.</span>emergencyAccess<span class=\"si\">}</span><span class=\"s2\">:::::::\"</span><span class=\"p\">;</span>\n\n        <span class=\"s2\">\"/bin\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> <span class=\"s2\">\"</span><span class=\"si\">${</span>initrdBinEnv<span class=\"si\">}</span><span class=\"s2\">/bin\"</span><span class=\"p\">;</span>\n        <span class=\"s2\">\"/sbin\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> <span class=\"s2\">\"</span><span class=\"si\">${</span>initrdBinEnv<span class=\"si\">}</span><span class=\"s2\">/sbin\"</span><span class=\"p\">;</span>\n\n        <span class=\"s2\">\"/etc/sysctl.d/nixos.conf\"</span><span class=\"o\">.</span><span class=\"ss\">text</span> <span class=\"o\">=</span> <span class=\"s2\">\"kernel.modprobe = /sbin/modprobe\"</span><span class=\"p\">;</span>\n        <span class=\"s2\">\"/etc/modprobe.d/systemd.conf\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> <span class=\"s2\">\"</span><span class=\"si\">${</span>cfg<span class=\"o\">.</span>package<span class=\"si\">}</span><span class=\"s2\">/lib/modprobe.d/systemd.conf\"</span><span class=\"p\">;</span>\n        <span class=\"s2\">\"/etc/modprobe.d/ubuntu.conf\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> pkgs<span class=\"o\">.</span>runCommand <span class=\"s2\">\"initrd-kmod-blacklist-ubuntu\"</span> <span class=\"p\">{</span> <span class=\"p\">}</span> <span class=\"s s-Multiline\">''</span>\n<span class=\"s s-Multiline\">          </span><span class=\"si\">${</span>pkgs<span class=\"o\">.</span>buildPackages<span class=\"o\">.</span>perl<span class=\"si\">}</span><span class=\"s s-Multiline\">/bin/perl -0pe 's/## file: iwlwifi.conf(.+?)##/##/s;' $src &gt; $out</span>\n<span class=\"s s-Multiline\">        ''</span><span class=\"p\">;</span>\n        <span class=\"s2\">\"/etc/modprobe.d/debian.conf\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> pkgs<span class=\"o\">.</span>kmod-debian-aliases<span class=\"p\">;</span>\n\n        <span class=\"s2\">\"/etc/os-release\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> config<span class=\"o\">.</span>boot<span class=\"o\">.</span>initrd<span class=\"o\">.</span>osRelease<span class=\"p\">;</span>\n        <span class=\"s2\">\"/etc/initrd-release\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> config<span class=\"o\">.</span>boot<span class=\"o\">.</span>initrd<span class=\"o\">.</span>osRelease<span class=\"p\">;</span>\n\n      <span class=\"p\">}</span> <span class=\"o\">//</span> optionalAttrs <span class=\"p\">(</span>config<span class=\"o\">.</span>environment<span class=\"o\">.</span>etc <span class=\"o\">?</span> <span class=\"s2\">\"modprobe.d/nixos.conf\"</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"s2\">\"/etc/modprobe.d/nixos.conf\"</span><span class=\"o\">.</span><span class=\"ss\">source</span> <span class=\"o\">=</span> config<span class=\"o\">.</span>environment<span class=\"o\">.</span>etc<span class=\"o\">.</span><span class=\"s2\">\"modprobe.d/nixos.conf\"</span><span class=\"o\">.</span>source<span class=\"p\">;</span>\n      <span class=\"p\">};</span>\n</code></pre></div>",
        "id": 417287157,
        "sender_full_name": "David Arnold",
        "timestamp": 1705946866
    },
    {
        "content": "<p>If you have an embedded usecade, clever's not-os might be a better choice fundamentally, as this is its goal from the outset.</p>",
        "id": 417287178,
        "sender_full_name": "Tim DeHerrera",
        "timestamp": 1705946875
    },
    {
        "content": "<p>That'd be fun, but in my case not really necessary. I just got a cheap IPv6-only 900mb vps collocated in Bogota (which is key, and otherwise <em>very</em> expensive).</p>",
        "id": 417287335,
        "sender_full_name": "David Arnold",
        "timestamp": 1705946930
    },
    {
        "content": "<p>I doubt it is the <code>initialRamdisk</code>, on my nixos machine when I check the size of initrd it shows just 12 MB:</p>\n<div class=\"codehilite\"><pre><span></span><code>ls -lah /nix/store/l8qssxmf3ff1c6g2iq6klcfahclxxgzb-initrd-linux-6.1.71/initrd\n.r--r--r-- root root 12 MB Thu Jan  1 05:30:01 1970  /nix/store/l8qssxmf3ff1c6g2iq6klcfahclxxgzb-initrd-linux-6.1.71/initrd\n</code></pre></div>\n<p>This is how I built the initrd:</p>\n<div class=\"codehilite\"><pre><span></span><code>nix build .#nixosConfigurations.nixos.config.system.build.initialRamdisk\n</code></pre></div>",
        "id": 417303743,
        "sender_full_name": "Shivaraj B H",
        "timestamp": 1705952949
    },
    {
        "content": "<p>I'll re-check tomorrow. I somehow need a better testing handle on this piece of software to be able to actually assess the max- memory consumption.</p>\n<p>Last time I felt lucky and just deployed, then the VM got stuck and hanged and I had to wait two business days for a manual intervention. Not fun <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 417326520,
        "sender_full_name": "David Arnold",
        "timestamp": 1705962185
    },
    {
        "content": "<p>900mb is pretty tight. Definitely use an OOM killer daemon on that thing. That will at least help you avoid another manual intervention <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 417344640,
        "sender_full_name": "Tim DeHerrera",
        "timestamp": 1705970201
    },
    {
        "content": "<p>this will get you much further</p>\n<div class=\"codehilite\" data-code-language=\"Nix\"><pre><span></span><code>  <span class=\"ss\">zramSwap</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    <span class=\"ss\">enable</span> <span class=\"o\">=</span> <span class=\"no\">true</span><span class=\"p\">;</span>\n    <span class=\"ss\">memoryPercent</span> <span class=\"o\">=</span> <span class=\"mi\">150</span><span class=\"p\">;</span>\n  <span class=\"p\">};</span>\n</code></pre></div>",
        "id": 417376084,
        "sender_full_name": "sedlund",
        "timestamp": 1705989147
    },
    {
        "content": "<p>Yeah, I just need it as a reverse proxy with stable IP as failover route in front of a mobile network backup internet link for a site with normally static IP wire-line link, where the site tunnels via wireguard onto that machine to establishes a stable route in case of issue with the main link.</p>\n<p>I think an OOM daemon might not do much, because it's already after the kexec when this happens and apparently during the loading of the <code>initrd</code>.</p>\n<p><span class=\"user-mention\" data-user-id=\"685336\">@sedlund</span> , I'll try your suggestion, although the docs say that swap wouldn't help much and that the requirement is 1.5gb (exclusive of swap). I didn't know about <code>zram</code>, this is really interesting!</p>\n<p>They don't explain _why_ \"no swap\" and maybe they should be more precise and change that to \"no disk swap\" if your suspicion is right.</p>",
        "id": 417382646,
        "sender_full_name": "David Arnold",
        "timestamp": 1705993409
    },
    {
        "content": "<p>With nixos-anywhere you are looking to format your disk while being on the ram and swap exists on the disk, which is why it doesn’t help.</p>",
        "id": 417498394,
        "sender_full_name": "Shivaraj B H",
        "timestamp": 1706032261
    },
    {
        "content": "<p>I haven't come around to test this yet, but it looks like <code>zramSwap</code> is a compressed swap on ram, effectively making the RAM apparently bigger than it really is through compression. If that work's that'd be fun and really nice.</p>",
        "id": 417515488,
        "sender_full_name": "David Arnold",
        "timestamp": 1706038649
    },
    {
        "content": "<p>right, 150% is what google uses on ChromeOS.  you will see typically 4:1 compression in regular workloads.  the setting is not particular to nixos-anywhere (when building remotely), just useful on ram limited machines and in general.   Windows does ram compression by default as does Fedora with zram</p>",
        "id": 417567243,
        "sender_full_name": "sedlund",
        "timestamp": 1706065586
    },
    {
        "content": "<p>fwiw I also use a cheap RAM limited vps from digitalocean (1G). I haven't yet installed nixos on it (intended to, but I was in a rush at the time).</p>\n<p>Its only use is as a <a href=\"https://github.com/slackhq/nebula\">nebula lighthouse</a> to create a network between some of my personal devices, and it hasn't had any issue since I set it up so I kinda forgot about it.</p>\n<p>Might have to circle back around at some point, if just for usage comparison's sake.</p>",
        "id": 417568638,
        "sender_full_name": "Tim DeHerrera",
        "timestamp": 1706066538
    }
]